{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extrahead %}
<style>
    /* Main Layout */
    body.hotspot-editor {
        background: #000;
        overflow-x: hidden;
    }
    
    #hotspot-editor-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* Header Section */
    .editor-header {
        background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
        border: 1px solid #d9b38a;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .editor-header h1 {
        color: #d9b38a;
        font-size: 24px;
        margin: 0 0 10px 0;
    }
    
    .room-info {
        color: #ccc;
        font-size: 14px;
    }
    
    /* Panorama Container */
    #panorama-container {
        position: relative;
        width: 100%;
        height: 700px;
        background: #000;
        border: 2px solid #d9b38a;
        border-radius: 10px;
        overflow: hidden;
        cursor: crosshair;
        margin-bottom: 20px;
    }
    
    #panorama-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    
    /* Hotspot Styles */
    .hotspot {
        position: absolute;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(212, 175, 55, 0.8);
        border: 3px solid #d9b38a;
        cursor: move;
        transform: translate(-50%, -50%);
        animation: pulse 2s infinite;
        transition: all 0.3s ease;
        z-index: 10;
    }
    
    .hotspot:hover {
        transform: translate(-50%, -50%) scale(1.1);
        background: rgba(212, 175, 55, 1);
    }
    
    .hotspot.dragging {
        animation: none;
        opacity: 0.8;
        cursor: grabbing;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
        70% { box-shadow: 0 0 0 20px rgba(212, 175, 55, 0); }
        100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
    }
    
    /* Hotspot Icon */
    .hotspot-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        color: #000;
    }
    
    /* Hotspot Label */
    .hotspot-label {
        position: absolute;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: #d9b38a;
        padding: 5px 10px;
        border-radius: 5px;
        white-space: nowrap;
        font-size: 12px;
        font-weight: bold;
        border: 1px solid #d9b38a;
    }
    
    /* Temporary Marker */
    .temp-marker {
        position: absolute;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255, 0, 0, 0.5);
        border: 3px solid #ff0000;
        transform: translate(-50%, -50%);
        animation: blink 0.5s infinite;
        z-index: 20;
    }
    
    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    /* Controls Panel */
    .controls-panel {
        background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
        border: 1px solid #d9b38a;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .controls-panel h3 {
        color: #d9b38a;
        margin-top: 0;
        font-size: 18px;
    }
    
    /* Coordinate Display */
    #coordinate-display {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.9);
        color: #d9b38a;
        padding: 15px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        border: 1px solid #d9b38a;
        z-index: 1000;
    }
    
    /* Instructions Box */
    .instructions-box {
        background: rgba(26, 26, 26, 0.9);
        border: 1px solid #d9b38a;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .instructions-box h4 {
        color: #d9b38a;
        margin-top: 0;
    }
    
    .instructions-box ul {
        color: #ccc;
        margin: 10px 0;
        padding-left: 20px;
    }
    
    .instructions-box li {
        margin: 5px 0;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
    }
    
    .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #1a1a1a;
        border: 2px solid #d9b38a;
        border-radius: 10px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
    }
    
    .modal h3 {
        color: #d9b38a;
        margin-top: 0;
    }
    
    .modal-form-group {
        margin: 15px 0;
    }
    
    .modal-form-group label {
        display: block;
        color: #ccc;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .modal-form-group input,
    .modal-form-group select {
        width: 100%;
        padding: 8px;
        background: #2a2a2a;
        border: 1px solid #444;
        color: #fff;
        border-radius: 4px;
    }
    
    .modal-form-group select {
        cursor: pointer;
    }
    
    /* Icon Selector */
    .icon-selector {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 5px;
    }
    
    .icon-option {
        width: 50px;
        height: 50px;
        border: 2px solid #444;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        background: #2a2a2a;
        transition: all 0.3s ease;
    }
    
    .icon-option:hover {
        border-color: #d9b38a;
        background: #3a3a3a;
    }
    
    .icon-option.selected {
        border-color: #d9b38a;
        background: #d9b38a;
    }
    
    .icon-option span {
        font-size: 24px;
    }
    
    /* Buttons */
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        margin-right: 10px;
    }
    
    .btn-primary {
        background: #d9b38a;
        color: #000;
    }
    
    .btn-primary:hover {
        background: #c5a145;
    }
    
    .btn-danger {
        background: #dc3545;
        color: #fff;
    }
    
    .btn-danger:hover {
        background: #c82333;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: #fff;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
    }
    
    /* Existing Connections List */
    .connections-list {
        background: rgba(26, 26, 26, 0.9);
        border: 1px solid #d9b38a;
        border-radius: 8px;
        padding: 15px;
    }
    
    .connections-list h4 {
        color: #d9b38a;
        margin-top: 0;
    }
    
    .connection-item {
        background: #2a2a2a;
        border: 1px solid #444;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
    }
    
    .connection-item:hover {
        border-color: #d9b38a;
        background: #3a3a3a;
    }
    
    .connection-info {
        color: #ccc;
    }
    
    .connection-actions {
        display: flex;
        gap: 10px;
    }
    
    /* Toast Notifications */
    .toast {
        position: fixed;
        bottom: 80px;
        right: 20px;
        background: rgba(212, 175, 55, 0.95);
        color: #000;
        padding: 15px 20px;
        border-radius: 8px;
        font-weight: bold;
        z-index: 2000;
        display: none;
        animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .toast.error {
        background: rgba(220, 53, 69, 0.95);
        color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div id="hotspot-editor-container">
    <div class="editor-header">
        <h1>üéØ Visual Hotspot Editor</h1>
        <div class="room-info">
            <strong>Room:</strong> {{ room.name }} | 
            <strong>Type:</strong> {{ room.room_type }} | 
            <strong>Apartment:</strong> {{ room.apartment.name }}
        </div>
    </div>

    <div class="instructions-box">
        <h4>üìñ How to Use</h4>
        <ul>
            <li><strong>Add Hotspot:</strong> Click anywhere on the image where you want to place a door/navigation point</li>
            <li><strong>Move Hotspot:</strong> Click and drag any existing hotspot to adjust its position</li>
            <li><strong>Delete Hotspot:</strong> Click the delete button on any connection in the list below</li>
            <li><strong>Test Navigation:</strong> Double-click any hotspot to preview the destination room</li>
        </ul>
    </div>

    <div id="panorama-container">
        <img id="panorama-image" src="{{ room.panoramic_image.url }}" alt="{{ room.name }} Panorama">
        
        <!-- Render existing hotspots -->
        {% for connection in existing_connections %}
        <div class="hotspot" 
             data-id="{{ connection.id }}"
             data-to-room="{{ connection.to_room.id }}"
             style="left: {{ connection.hotspot_x }}%; top: {{ connection.hotspot_y }}%;">
            <span class="hotspot-icon">
                {% if connection.icon == 'door' %}üö™
                {% elif connection.icon == 'archway' %}üèõÔ∏è
                {% elif connection.icon == 'stairs' %}ü™ú
                {% elif connection.icon == 'elevator' %}üõó
                {% elif connection.icon == 'balcony' %}ü™ü
                {% else %}üö™
                {% endif %}
            </span>
            <span class="hotspot-label">{{ connection.direction_label|default:connection.to_room.name }}</span>
        </div>
        {% endfor %}
    </div>

    <div id="coordinate-display">
        <strong>Mouse Position:</strong><br>
        X: <span id="x-coord">0</span>%<br>
        Y: <span id="y-coord">0</span>%
    </div>

    <div class="connections-list">
        <h4>üìç Existing Connections ({{ existing_connections|length }})</h4>
        <div id="connections-container">
            {% for connection in existing_connections %}
            <div class="connection-item" data-connection-id="{{ connection.id }}">
                <div class="connection-info">
                    <strong>‚Üí {{ connection.to_room.name }}</strong><br>
                    <small>Position: ({{ connection.hotspot_x|floatformat:1 }}%, {{ connection.hotspot_y|floatformat:1 }}%)</small><br>
                    <small>Label: {{ connection.direction_label|default:"No label" }}</small>
                </div>
                <div class="connection-actions">
                    <button class="btn btn-secondary btn-sm" onclick="highlightHotspot({{ connection.id }})">
                        üëÅÔ∏è Show
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteHotspot({{ connection.id }})">
                        üóëÔ∏è Delete
                    </button>
                </div>
            </div>
            {% empty %}
            <p style="color: #666;">No connections yet. Click on the image to add hotspots!</p>
            {% endfor %}
        </div>
    </div>

    <div class="controls-panel">
        <h3>‚öôÔ∏è Quick Actions</h3>
        <button class="btn btn-primary" onclick="toggleGrid()">üìê Toggle Grid</button>
        <button class="btn btn-primary" onclick="toggleLabels()">üè∑Ô∏è Toggle Labels</button>
        <button class="btn btn-primary" onclick="testAllConnections()">üß™ Test All</button>
        <a href="{% url 'admin:apartments_virtualtourroom_change' room.id %}" class="btn btn-secondary">
            ‚Üê Back to Room
        </a>
    </div>
</div>

<!-- Hotspot Configuration Modal -->
<div id="hotspot-modal" class="modal">
    <div class="modal-content">
        <h3>üö™ Configure Navigation Hotspot</h3>
        <form id="hotspot-form">
            <div class="modal-form-group">
                <label>Position</label>
                <input type="text" id="modal-position" readonly style="background: #1a1a1a; color: #d9b38a;">
            </div>
            
            <div class="modal-form-group">
                <label>Destination Room *</label>
                <select id="modal-destination" required>
                    <option value="">Select a room...</option>
                    {% for dest_room in available_rooms %}
                    <option value="{{ dest_room.id }}">{{ dest_room.name }} ({{ dest_room.room_type }})</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="modal-form-group">
                <label>Button Label (optional)</label>
                <input type="text" id="modal-label" placeholder="e.g., 'To Kitchen', 'Exit to Balcony'">
            </div>
            
            <div class="modal-form-group">
                <label>Icon Type</label>
                <div class="icon-selector">
                    <div class="icon-option selected" data-icon="door">
                        <span>üö™</span>
                    </div>
                    <div class="icon-option" data-icon="archway">
                        <span>üèõÔ∏è</span>
                    </div>
                    <div class="icon-option" data-icon="stairs">
                        <span>ü™ú</span>
                    </div>
                    <div class="icon-option" data-icon="elevator">
                        <span>üõó</span>
                    </div>
                    <div class="icon-option" data-icon="balcony">
                        <span>ü™ü</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-form-group">
                <label>Transition Effect</label>
                <select id="modal-transition">
                    <option value="fade">Fade</option>
                    <option value="slide">Slide</option>
                    <option value="zoom">Zoom</option>
                </select>
            </div>
            
            <div style="margin-top: 20px;">
                <button type="submit" class="btn btn-primary">üíæ Save Hotspot</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Toast notification -->
<div id="toast" class="toast"></div>

<script>
// Global variables
let container = document.getElementById('panorama-container');
let image = document.getElementById('panorama-image');
let modal = document.getElementById('hotspot-modal');
let tempMarker = null;
let draggedHotspot = null;
let currentX = 0;
let currentY = 0;
let selectedIcon = 'door';
let showGrid = false;
let showLabels = true;

// CSRF token for AJAX requests
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
    setupIconSelector();
});

function initializeEventListeners() {
    // Track mouse position
    container.addEventListener('mousemove', function(e) {
        const rect = container.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width * 100).toFixed(1);
        const y = ((e.clientY - rect.top) / rect.height * 100).toFixed(1);
        
        document.getElementById('x-coord').textContent = x;
        document.getElementById('y-coord').textContent = y;
    });
    
    // Handle click to add hotspot
    container.addEventListener('click', function(e) {
        if (e.target === image) {
            const rect = container.getBoundingClientRect();
            currentX = ((e.clientX - rect.left) / rect.width * 100).toFixed(1);
            currentY = ((e.clientY - rect.top) / rect.height * 100).toFixed(1);
            
            // Remove any existing temp marker
            if (tempMarker) {
                tempMarker.remove();
            }
            
            // Create temporary marker
            tempMarker = document.createElement('div');
            tempMarker.className = 'temp-marker';
            tempMarker.style.left = currentX + '%';
            tempMarker.style.top = currentY + '%';
            container.appendChild(tempMarker);
            
            // Open configuration modal
            openModal(currentX, currentY);
        }
    });
    
    // Setup drag functionality for existing hotspots
    setupHotspotDragging();
    
    // Form submission
    document.getElementById('hotspot-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveHotspot();
    });
}

function setupHotspotDragging() {
    document.querySelectorAll('.hotspot').forEach(hotspot => {
        let isDragging = false;
        let startX, startY, initialX, initialY;
        
        hotspot.addEventListener('mousedown', function(e) {
            e.stopPropagation();
            isDragging = true;
            hotspot.classList.add('dragging');
            
            const rect = container.getBoundingClientRect();
            startX = e.clientX;
            startY = e.clientY;
            initialX = parseFloat(hotspot.style.left);
            initialY = parseFloat(hotspot.style.top);
            
            const mouseMoveHandler = function(e) {
                if (!isDragging) return;
                
                const deltaX = (e.clientX - startX) / rect.width * 100;
                const deltaY = (e.clientY - startY) / rect.height * 100;
                
                const newX = Math.max(0, Math.min(100, initialX + deltaX));
                const newY = Math.max(0, Math.min(100, initialY + deltaY));
                
                hotspot.style.left = newX + '%';
                hotspot.style.top = newY + '%';
            };
            
            const mouseUpHandler = function() {
                if (!isDragging) return;
                isDragging = false;
                hotspot.classList.remove('dragging');
                
                // Save new position
                updateHotspotPosition(hotspot.dataset.id, 
                                    parseFloat(hotspot.style.left), 
                                    parseFloat(hotspot.style.top));
                
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
            };
            
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
        });
        
        // Double-click to preview destination
        hotspot.addEventListener('dblclick', function(e) {
            e.stopPropagation();
            const toRoomId = hotspot.dataset.toRoom;
            showToast('Preview: Navigating to room ID ' + toRoomId);
        });
    });
}

function setupIconSelector() {
    document.querySelectorAll('.icon-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            selectedIcon = this.dataset.icon;
        });
    });
}

function openModal(x, y) {
    document.getElementById('modal-position').value = `X: ${x}%, Y: ${y}%`;
    modal.style.display = 'block';
}

function closeModal() {
    modal.style.display = 'none';
    if (tempMarker) {
        tempMarker.remove();
        tempMarker = null;
    }
}

async function saveHotspot() {
    const destination = document.getElementById('modal-destination').value;
    const label = document.getElementById('modal-label').value;
    const transition = document.getElementById('modal-transition').value;
    
    if (!destination) {
        showToast('Please select a destination room', 'error');
        return;
    }
    
    try {
        const response = await fetch(`{% url 'admin:apartments_virtualtourroom_save_hotspot' room.id %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                x: parseFloat(currentX),
                y: parseFloat(currentY),
                to_room_id: destination,
                label: label || '',
                icon: selectedIcon,
                transition: transition
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('‚úÖ Hotspot created successfully!');
            closeModal();
            // Reload to show new hotspot
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Network error: ' + error, 'error');
    }
}

async function updateHotspotPosition(connectionId, x, y) {
    try {
        const response = await fetch(`{% url 'admin:apartments_virtualtourroom_update_hotspot_position' room.id 0 %}`.replace('0', connectionId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                x: x,
                y: y
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('‚úÖ Position updated');
        } else {
            showToast('Error updating position', 'error');
        }
    } catch (error) {
        showToast('Network error', 'error');
    }
}

async function deleteHotspot(hotspotId) {
    if (!confirm('Are you sure you want to delete this connection?')) {
        return;
    }
    
    try {
        const response = await fetch(`{% url 'admin:apartments_virtualtourroom_delete_hotspot' room.id 0 %}`.replace('0', hotspotId), {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('‚úÖ Hotspot deleted');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error deleting hotspot', 'error');
        }
    } catch (error) {
        showToast('Network error', 'error');
    }
}

function highlightHotspot(hotspotId) {
    const hotspot = document.querySelector(`.hotspot[data-id="${hotspotId}"]`);
    if (hotspot) {
        // Temporarily increase size and add glow
        hotspot.style.transform = 'translate(-50%, -50%) scale(1.5)';
        hotspot.style.boxShadow = '0 0 30px #d9b38a';
        
        setTimeout(() => {
            hotspot.style.transform = 'translate(-50%, -50%) scale(1)';
            hotspot.style.boxShadow = '';
        }, 2000);
    }
}

function toggleGrid() {
    showGrid = !showGrid;
    // Implementation for grid overlay
    showToast(showGrid ? 'Grid enabled' : 'Grid disabled');
}

function toggleLabels() {
    const labels = document.querySelectorAll('.hotspot-label');
    showLabels = !showLabels;
    labels.forEach(label => {
        label.style.display = showLabels ? 'block' : 'none';
    });
    showToast(showLabels ? 'Labels shown' : 'Labels hidden');
}

function testAllConnections() {
    const hotspots = document.querySelectorAll('.hotspot');
    let index = 0;
    
    const interval = setInterval(() => {
        if (index >= hotspots.length) {
            clearInterval(interval);
            return;
        }
        
        highlightHotspot(hotspots[index].dataset.id);
        index++;
    }, 500);
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast ' + (type === 'error' ? 'error' : '');
    toast.style.display = 'block';
    
    setTimeout(() => {
        toast.style.display = 'none';
    }, 3000);
}

// Close modal when clicking outside
window.onclick = function(event) {
    if (event.target === modal) {
        closeModal();
    }
}
</script>
{% endblock %}

{% block bodyclass %}hotspot-editor{% endblock %}